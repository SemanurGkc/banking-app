<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>Account Details – Banking App</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="shared.css" />
</head>
<body>

<aside class="sidebar" id="sidebar"></aside>

<div class="main">
    <div class="topbar">
        <div style="display:flex;align-items:center;gap:12px">
            <button class="btn-back" id="backBtn">← Back</button>
            <h1>Account Details</h1>
        </div>
        <div class="avatar" id="userAvatar">?</div>
    </div>

    <div class="account-hero">
        <div>
            <div class="acc-lbl">ACCOUNT HOLDER</div>
            <div class="acc-name" id="detailName">Loading…</div>
            <div class="acc-id"   id="detailId">#–</div>
        </div>
        <div style="text-align:right">
            <div class="acc-lbl">CURRENT BALANCE</div>
            <div class="bal-amount" id="detailBalance">₺ –</div>
        </div>
    </div>

    <div class="action-grid">
        <div class="card action-card">
            <div class="action-icon">⬆</div>
            <h3 class="action-title">Deposit</h3>
            <div class="fg"><label>Amount (₺)</label><input type="number" id="depositAmount" placeholder="0.00" min="0" /></div>
            <button class="btn-primary btn-deposit" onclick="doDeposit()">Deposit Funds</button>
            <div class="status-msg" id="depositStatus"></div>
        </div>
        <div class="card action-card">
            <div class="action-icon">⬇</div>
            <h3 class="action-title">Withdraw</h3>
            <div class="fg"><label>Amount (₺)</label><input type="number" id="withdrawAmount" placeholder="0.00" min="0" /></div>
            <button class="btn-primary btn-withdraw" onclick="doWithdraw()">Withdraw Funds</button>
            <div class="status-msg" id="withdrawStatus"></div>
        </div>
    </div>

    <div class="sec-title" style="margin-top:28px">Transaction History</div>
    <div class="card">
        <div class="card-hdr">
            <span class="card-hdr-title">All Transactions</span>
            <span class="badge" id="txBadge">0</span>
        </div>
        <div id="txList"><div class="empty">Loading…</div></div>
    </div>
</div>

<script src="shared.js"></script>
<script>
    const params    = new URLSearchParams(location.search);
    const accountId = params.get("id");

    async function init() {
        await checkAuth("userAvatar");

        if (isUser() && !accountId) {
            const accounts = await apiFetch("/api/v1/accounts");
            if (accounts.length) location.href = `account.html?id=${accounts[0].id}`;
            else location.href = "dashboard.html";
            return;
        }

        if (!accountId) { location.href = "accounts.html"; return; }

        document.getElementById("sidebar").innerHTML = buildSidebar("accounts");

        document.getElementById("backBtn").onclick = () =>
            location.href = isAdmin() ? "accounts.html" : "dashboard.html";

        await loadDetails();
        await loadTx();
    }

    async function loadDetails() {
        const acc = await apiFetch(`/api/v1/accounts/${accountId}`);
        document.getElementById("detailName").textContent    = acc.accountHolderName;
        document.getElementById("detailId").textContent      = "#" + acc.id;
        document.getElementById("detailBalance").textContent = "₺ " + fmt(acc.balance);
        document.title = acc.accountHolderName + " – Banking App";
    }

    async function loadTx() {
        const txs = await apiFetch(`/api/v1/accounts/${accountId}/transactions`);
        document.getElementById("txBadge").textContent = txs.length;
        txs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        renderTxList(txs, "txList", false);
    }

    async function doDeposit() {
        const amount = Number(document.getElementById("depositAmount").value);
        if (!amount || amount <= 0) { setStatus("depositStatus", "Enter a valid amount.", "err"); return; }
        setStatus("depositStatus", "Processing…", "");
        const res = await fetch(`${BASE}/api/v1/accounts/${accountId}/deposit`, {
            method: "PUT", credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ amount })
        });
        if (res.ok) {
            document.getElementById("depositAmount").value = "";
            setStatus("depositStatus", "Deposit successful ✓", "ok");
            await loadDetails(); await loadTx();
        } else { setStatus("depositStatus", "Transaction failed.", "err"); }
    }

    async function doWithdraw() {
        const amount = Number(document.getElementById("withdrawAmount").value);
        if (!amount || amount <= 0) { setStatus("withdrawStatus", "Enter a valid amount.", "err"); return; }
        setStatus("withdrawStatus", "Processing…", "");
        const res = await fetch(`${BASE}/api/v1/accounts/${accountId}/withdraw`, {
            method: "PUT", credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ amount })
        });
        if (res.ok) {
            document.getElementById("withdrawAmount").value = "";
            setStatus("withdrawStatus", "Withdrawal successful ✓", "ok");
            await loadDetails(); await loadTx();
        } else { setStatus("withdrawStatus", "Insufficient funds or error.", "err"); }
    }

    init();
</script>
</body>
</html>